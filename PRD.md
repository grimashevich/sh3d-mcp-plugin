# PRD: Sweet Home 3D MCP Plugin

## 1. Бизнес-проблема

### Контекст
Sweet Home 3D — популярное приложение для дизайна интерьеров. Однако создание планировок вручную через GUI требует времени, навыков и повторяющихся действий. Нет программного способа управлять сценой извне.

### Боли пользователей

| Боль | Описание | Severity |
|------|----------|----------|
| **Отсутствие автоматизации** | Невозможно программно создавать и модифицировать планировки. Каждое действие — ручное | HIGH |
| **Нет интеграции с AI** | Claude и другие LLM не могут управлять Sweet Home 3D, хотя могли бы генерировать планировки по текстовому описанию | HIGH |
| **Повторяющиеся рутинные действия** | Создание типовых планировок (стены, расстановка мебели) требует одних и тех же ручных шагов | MEDIUM |
| **Разрыв между описанием и результатом** | Пользователь знает, что хочет ("комната 5x4 метра со столом в центре"), но должен вручную переводить это в действия GUI | MEDIUM |

### Целевой пользователь
- Дизайнеры интерьеров, использующие Sweet Home 3D для быстрого прототипирования
- Разработчики, интегрирующие AI-инструменты в рабочие процессы проектирования
- Энтузиасты, желающие генерировать планировки через естественный язык (Claude)

---

## 2. Решение

Плагин для Sweet Home 3D со встроенным HTTP MCP-сервером, который:
1. Реализует MCP протокол (Streamable HTTP, JSON-RPC 2.0) напрямую внутри JVM приложения (порт 9877, endpoint `/mcp`)
2. Принимает запросы от Claude без внешних прокси-процессов
3. Служит мостом между Claude и Java API Sweet Home 3D

```
Claude ──HTTP:9877/mcp (JSON-RPC 2.0)──► Plugin (MCP-сервер внутри SH3D JVM) ──► Java API
```

---

## 3. Функциональные требования

### FR-1: HTTP MCP-сервер плагина
| Параметр | Значение |
|----------|----------|
| Протокол | HTTP, Streamable HTTP (JSON-RPC 2.0, MCP `2025-03-26`) |
| Endpoint | `http://127.0.0.1:9877/mcp` |
| Порт по умолчанию | 9877 (настраиваемый) |
| Управление | Пункт меню в SH3D: Start / Stop сервера, autoStart по умолчанию |
| Жизненный цикл | Daemon-поток; корректная остановка при закрытии SH3D |
| Thread-safety | Все модификации модели — через `SwingUtilities.invokeAndWait()` (EDT) |

### FR-2: Команда `create_walls`
- **Вход:** `x`, `y` (float, см), `width`, `height` (float, см), `thickness` (float, default 10)
- **Действие:** Создать 4 объекта `Wall` по периметру прямоугольника, соединить их (`setWallAtStart/End`)
- **Выход:** `{"status": "ok", "data": {"wallsCreated": 4, "message": "Room WxH created"}}`
- **Критерий приёмки:** Стены отображаются в SH3D, углы корректно соединены

### FR-3: Команда `place_furniture`
- **Вход:** `name` (string, поиск case-insensitive contains), `x`, `y` (float, см), `angle` (float, градусы, default 0)
- **Действие:** Найти в каталоге → создать `HomePieceOfFurniture` → установить позицию и угол (в радианах) → добавить в `Home`
- **Выход:** данные размещённой мебели или ошибка "Furniture not found"
- **Критерий приёмки:** Мебель появляется на плане в указанных координатах

### FR-4: Команда `get_state`
- **Вход:** нет параметров
- **Выход:** JSON с количеством стен, списком мебели (имя, x, y, угол, размеры), количеством комнат, bounding box
- **Критерий приёмки:** Корректно отражает текущее состояние сцены

### FR-5: Команда `list_furniture_catalog`
- **Вход:** `query` (string, опционально), `category` (string, опционально)
- **Выход:** массив `{name, category, width, depth, height}`
- **Критерий приёмки:** Возвращает все элементы при пустом запросе, фильтрует при наличии параметров

### FR-6: Команда `ping`
- **Вход:** нет
- **Выход:** `{"status": "ok", "version": "0.1.0"}`
- **Критерий приёмки:** Мгновенный ответ, подтверждает работоспособность соединения

---

## 4. Нефункциональные требования

| ID | Требование | Детали |
|----|-----------|--------|
| NFR-1 | **Совместимость** | Java 11+, совместимость с JVM Sweet Home 3D |
| NFR-2 | **Без внешних зависимостей** | Только classpath SH3D. JSON парсится вручную (рекурсивный descent-парсер). Внешние JSON-библиотеки запрещены |
| NFR-3 | **Артефакт** | Один `.sh3p`-файл (ZIP/JAR), копируется в папку plugins SH3D |
| NFR-4 | **Thread-safety** | Все мутации модели через EDT (`invokeAndWait`), HTTP-сервер в daemon-потоке |
| NFR-5 | **Координатная система** | Сантиметры. X — вправо, Y — вниз |
| NFR-6 | **Корректное завершение** | При закрытии SH3D сервер останавливается без утечек ресурсов |

---

## 5. Метрики успеха

| Метрика | Целевое значение | Как измеряем |
|---------|-----------------|-------------|
| **Стабильность соединения** | HTTP MCP-сервер работает без разрывов в течение сессии SH3D | Длительный тест: 1 час непрерывной работы |
| **Корректность create_walls** | 100% стен корректно соединены и отображаются | Визуальная проверка + `get_state` |
| **Корректность place_furniture** | Мебель появляется в точных координатах | Сравнение входных координат с `get_state` |
| **Время отклика** | < 200 мс на команду (исключая поиск в большом каталоге) | Замер latency HTTP round-trip |
| **Полнота каталога** | `list_furniture_catalog` возвращает все элементы встроенного каталога | Сравнение count с GUI-каталогом |
| **End-to-end сценарий** | Claude через MCP может: создать комнату → расставить мебель → получить состояние | Демо-сценарий |

---

## 6. Приоритизация фич (Impact vs Effort)

```
                        HIGH IMPACT
                            |
         ┌──────────────────┼──────────────────┐
         │   Quick Wins     │   Big Bets        │
         │                  │                   │
         │  FR-6 ping       │  FR-2 create_walls│
         │  FR-4 get_state  │  FR-3 place_furn. │
         │                  │  FR-1 HTTP MCP    │
LOW ─────┼──────────────────┼───────────────────┼───── HIGH
EFFORT   │                  │                   │   EFFORT
         │  Fill-ins        │  Money Pit        │
         │                  │                   │
         │  FR-5 list_cat.  │  (нет в MVP)      │
         │                  │                   │
         └──────────────────┼───────────────────┘
                            |
                        LOW IMPACT
```

### Порядок реализации (рекомендуемый)

| Приоритет | Фича | Impact | Effort | Обоснование |
|-----------|-------|--------|--------|-------------|
| **P0** | FR-1: HTTP MCP-сервер + архитектура плагина | Критический | Высокий | Фундамент для всего. Без сервера ничего не работает |
| **P0** | FR-6: `ping` | Средний | Минимальный | Первая команда для верификации протокола. Реализуется одновременно с HTTP-сервером |
| **P1** | FR-2: `create_walls` | Высокий | Средний | Ключевая фича MVP — создание планировки. Первая реальная интеграция с Java API |
| **P1** | FR-4: `get_state` | Высокий | Низкий | Необходима для верификации результатов и обратной связи для Claude |
| **P2** | FR-3: `place_furniture` | Высокий | Средний | Вторая ключевая фича. Зависит от понимания API каталога |
| **P2** | FR-5: `list_furniture_catalog` | Средний | Низкий | Вспомогательная для `place_furniture` — нужна чтобы Claude знал, что можно разместить |

---

## 7. Что явно исключено из MVP (v0.1)

> **Примечание:** Следующие возможности изначально были исключены из MVP, но были реализованы в последующих версиях: комнаты (`create_room_polygon`), экспорт (SVG, PNG, OBJ), текстуры (`apply_texture`, `list_textures_catalog`), камеры (`set_camera`, `store_camera`, `get_cameras`), рендеринг (`render_photo`), уровни/этажи (`add_level`, `list_levels`, `set_selected_level`, `delete_level`), одиночные стены произвольной формы (`create_wall`), метки и размерные линии, произвольные 3D-фигуры (`generate_shape`), чекпоинты (undo/redo), пакетные команды, настройки окружения.

Остаётся за пределами текущего скоупа:
- Видеотуры
- glTF-экспорт

---

## 8. Технические ограничения и риски

| Риск | Вероятность | Влияние | Митигация |
|------|------------|---------|-----------|
| EDT deadlock при `invokeAndWait` | Средняя | Высокое | Тщательная обработка исключений, timeout на invokeAndWait |
| Каталог мебели может отличаться у разных пользователей (доп. библиотеки) | Высокая | Низкое | Поиск по тому каталогу, что загружен — документировать поведение |
| Порт 9877 может быть занят | Низкая | Среднее | Настраиваемый порт, понятное сообщение об ошибке |
| Несколько клиентов одновременно | Средняя | Среднее | Поддержка сессий через `Mcp-Session-Id`. Параллельные сессии возможны, но общая модель `Home` одна |
| SH3D обновится и сломает Plugin API | Низкая | Высокое | Минимальная зависимость от API, тесты совместимости |

---

## 9. Definition of Done (MVP v0.1)

- [x] `.sh3p`-артефакт собирается одной командой (`mvn clean package`)
- [x] Плагин загружается в SH3D, появляется пункт меню Start/Stop
- [x] HTTP MCP-сервер принимает запросы на настраиваемом порту (Streamable HTTP, JSON-RPC 2.0)
- [x] Все 5 базовых команд работают корректно (`ping`, `create_walls`, `place_furniture`, `get_state`, `list_furniture_catalog`)
- [x] Стены визуально корректны (соединены в углах)
- [x] Мебель размещается в указанных координатах
- [x] Сервер корректно останавливается при закрытии SH3D
- [x] End-to-end: Claude через MCP создаёт комнату и расставляет мебель
